import{r as l,M as e}from"./vendor-CIPdjx1t.js";import{a as ce,B as x,C as S,b as Z,c as J,d as B,L as A,S as Re,e as _e,f as Ie,g as Pe,h as b,i as F,D as $e,j as Ae,k as Oe,l as Le}from"./index-Q594mB1I.js";import{S as Me}from"./switch-B92w76t-.js";import{u as Ke,a as Se}from"./usePreference-BdPvxwX6.js";import{R as me,L as Be,b as ge,B as Fe,d as ve,A as Ge,e as Ne,C as ze,X as He,Y as We,T as Ve,a as Xe}from"./chart-vendor-CWmmjCk1.js";import{c as oe,h as qe,f as Q,X as ye,R as Ye,S as Ze}from"./icon-vendor-CWV3Q6sV.js";import"./utils-vendor-DrCDvq1f.js";import"./ui-vendor-C5A5DcrM.js";const it=()=>{const[U,G]=l.useState({}),[z,H]=l.useState(null),[T,ee]=l.useState(!0),[de,Te]=l.useState(null),[ue,xe]=l.useState(0),[O,te]=l.useState({open:!1,title:"",data:[]}),L=l.useRef(null),M=l.useRef(null),[m,he]=l.useState({time1Start:"",time1End:"",time2Start:"",time2End:""}),[f,je]=l.useState({time1:!1,time2:!1}),{settings:t={},saving:fe=!1,error:pe=null,updateSettings:y=()=>{}}=Ke(),{settings:w={}}=Se(),p=l.useMemo(()=>Array.isArray(t==null?void 0:t.selectedPegs)?t.selectedPegs:[],[t==null?void 0:t.selectedPegs]),D=l.useMemo(()=>(w==null?void 0:w.statisticsSettings)||{},[w==null?void 0:w.statisticsSettings]),W=l.useMemo(()=>Array.isArray(D.selectedNEs)?D.selectedNEs:[],[D.selectedNEs]),V=l.useMemo(()=>Array.isArray(D.selectedCellIds)?D.selectedCellIds:[],[D.selectedCellIds]),g=l.useMemo(()=>(t==null?void 0:t.autoRefreshInterval)||30,[t==null?void 0:t.autoRefreshInterval]),K=l.useMemo(()=>(t==null?void 0:t.chartStyle)||"line",[t==null?void 0:t.chartStyle]),se=l.useMemo(()=>(t==null?void 0:t.chartLayout)||"byPeg",[t==null?void 0:t.chartLayout]),ae=l.useMemo(()=>(t==null?void 0:t.showLegend)!==!1,[t==null?void 0:t.showLegend]),le=l.useMemo(()=>(t==null?void 0:t.showGrid)!==!1,[t==null?void 0:t.showGrid]),X=l.useMemo(()=>(t==null?void 0:t.defaultNe)||"",[t==null?void 0:t.defaultNe]),q=l.useMemo(()=>(t==null?void 0:t.defaultCellId)||"",[t==null?void 0:t.defaultCellId]),Ce=l.useMemo(()=>(t==null?void 0:t.defaultTimeRange)||30,[t==null?void 0:t.defaultTimeRange]),k=l.useMemo(()=>(t==null?void 0:t.time1Start)||"",[t==null?void 0:t.time1Start]),R=l.useMemo(()=>(t==null?void 0:t.time1End)||"",[t==null?void 0:t.time1End]),_=l.useMemo(()=>(t==null?void 0:t.time2Start)||"",[t==null?void 0:t.time2Start]),I=l.useMemo(()=>(t==null?void 0:t.time2End)||"",[t==null?void 0:t.time2End]),u=l.useMemo(()=>(t==null?void 0:t.enableTimeComparison)||!1,[t==null?void 0:t.enableTimeComparison]),Ee=l.useCallback(s=>{console.log("[Dashboard] 기본시간범위 업데이트:",s),y({defaultTimeRange:parseInt(s)})},[y]),be=l.useCallback(s=>{console.log("[Dashboard] 토글 상태 변경:",s),y({enableTimeComparison:s})},[y]),Y=l.useCallback((s,d,o)=>{console.log("[Dashboard] 임시 시간 설정 업데이트:",s,d,o),he(i=>({...i,[`${s}${d}`]:o}))},[]),we=l.useCallback(()=>{m.time1Start&&m.time1End&&(console.log("[Dashboard] Time1 설정 적용:",m.time1Start,m.time1End),y({time1Start:m.time1Start,time1End:m.time1End}),je(s=>({...s,time1:!0})))},[m.time1Start,m.time1End,y]),De=l.useCallback(()=>{m.time2Start&&m.time2End&&(console.log("[Dashboard] Time2 설정 적용:",m.time2Start,m.time2End),y({time2Start:m.time2Start,time2End:m.time2End}),je(s=>({...s,time2:!0})))},[m.time2Start,m.time2End,y]);l.useEffect(()=>{console.log("[Dashboard] enableTimeComparison 상태 변경:",u)},[u]),l.useEffect(()=>{he(s=>({...s,time1Start:k||"",time1End:R||"",time2Start:_||"",time2End:I||""}))},[k,R,_,I]);const ie=l.useCallback(s=>s,[]),v=l.useCallback(s=>{const d=["#8884d8","#82ca9d","#ffc658","#ff7300","#8dd1e1","#d084d0"];return s<d.length?d[s]:`hsl(${s*47%360}, 70%, 50%)`},[]),P=l.useCallback(async()=>{var i,r,n;const s=p.length>0?p:["randomaccessproblem"],d=W.length>0?W:["NVGNB#101086"],o=V.length>0?V.map(a=>parseInt(a)):[8418];if(console.log("[Dashboard] 데이터 fetching 시작 - 상태 확인",{selectedPegs:p,safeSelectedPegs:s,selectedNEs:W,safeSelectedNEs:d,selectedCellIds:V,safeSelectedCellIds:o,defaultNe:X,defaultCellId:q,enableTimeComparison:u,time1Start:k,time1End:R,time2Start:_,time2End:I}),s.length===0){console.log("[Dashboard] 선택된 PEG가 없음 - 데이터 fetching 중단"),G({}),H(null),ee(!1);return}try{if(ee(!0),u&&k&&R&&_&&I){console.log("[Dashboard] Time1/Time2 비교 모드로 데이터 fetching");const a={start_date:k,end_date:R,kpi_types:s,ne:d,cellid:o};console.log("[Dashboard] Time1 API 파라미터:",a);const c=await ce.post("/api/kpi/query",a),j={start_date:_,end_date:I,kpi_types:s,ne:d,cellid:o};console.log("[Dashboard] Time2 API 파라미터:",j);const h=await ce.post("/api/kpi/query",j),N=((i=c==null?void 0:c.data)==null?void 0:i.data)||{},$=((r=h==null?void 0:h.data)==null?void 0:r.data)||{};G(N),H($),console.log("[Dashboard] Time1/Time2 데이터 fetching 완료",{time1KpiCount:Object.keys(N).length,time1TotalRows:Object.values(N).reduce((C,E)=>C+((E==null?void 0:E.length)||0),0),time2KpiCount:Object.keys($).length,time2TotalRows:Object.values($).reduce((C,E)=>C+((E==null?void 0:E.length)||0),0),time1DataKeys:Object.keys(N),time2DataKeys:Object.keys($)})}else{console.log("[Dashboard] 일반 모드로 데이터 fetching");const a=new Date,c=new Date(a.getTime()-((t==null?void 0:t.defaultHours)||1)*60*60*1e3),j={kpi_types:s,ne:d,cellid:o,start:c.toISOString(),end:a.toISOString()};console.log("[Dashboard] 일반 모드 API 파라미터:",j);const h=await ce.post("/api/kpi/timeseries",j),N=((n=h==null?void 0:h.data)==null?void 0:n.data)||{};G(N),H(null),console.log("[Dashboard] 일반 모드 데이터 fetching 완료",{kpiCount:Object.keys(N).length,totalRows:Object.values(N).reduce(($,C)=>$+((C==null?void 0:C.length)||0),0),dataKeys:Object.keys(N)})}Te(new Date)}catch(a){console.error("[Dashboard] 데이터 fetching 오류:",a),G({}),H(null)}finally{ee(!1)}},[p,W,V,t==null?void 0:t.defaultHours,X,q,u,k,R,_,I]);l.useEffect(()=>(L.current&&clearInterval(L.current),M.current&&clearInterval(M.current),g>0&&(console.log("[Dashboard] 자동 새로고침 설정:",g,"초"),L.current=setInterval(()=>{P()},g*1e3),xe(g),M.current=setInterval(()=>{xe(s=>s<=1?g:s-1)},1e3)),()=>{L.current&&clearInterval(L.current),M.current&&clearInterval(M.current)}),[g,P]),l.useEffect(()=>{P()},[P]);const ne=l.useCallback(()=>{console.log("[Dashboard] 수동 새로고침 실행"),P()},[P]),re=l.useCallback((s,d,o)=>{const i=s.length>0?Object.keys(s[0]).filter(a=>a!=="time"):[],r={data:s,className:"h-64"},n=[le&&e.jsx(ze,{strokeDasharray:"3 3"},"grid"),e.jsx(He,{dataKey:"time"},"xaxis"),e.jsx(We,{},"yaxis"),e.jsx(Ve,{},"tooltip"),ae&&e.jsx(Xe,{},"legend")].filter(Boolean);switch(K){case"area":return e.jsx(me,{width:"100%",height:"100%",children:e.jsxs(Ge,{...r,children:[n,i.map((a,c)=>{if(u&&a.includes("_Time")){const j=a.replace("_Time1","").replace("_Time2",""),h=a.includes("_Time1");return e.jsx(Ne,{type:"monotone",dataKey:a,stroke:v((o+c)%12),fill:v((o+c)%12),fillOpacity:.3,strokeWidth:2,strokeDasharray:h?void 0:"5 5",name:`${j} (${h?"Time1":"Time2"})`},a)}else return e.jsx(Ne,{type:"monotone",dataKey:a,stroke:v((o+c)%12),fill:v((o+c)%12),fillOpacity:.3,strokeWidth:2},a)})]})});case"bar":return e.jsx(me,{width:"100%",height:"100%",children:e.jsxs(Fe,{...r,children:[n,i.map((a,c)=>{if(u&&a.includes("_Time")){const j=a.replace("_Time1","").replace("_Time2",""),h=a.includes("_Time1");return e.jsx(ve,{dataKey:a,fill:v((o+c)%12),name:`${j} (${h?"Time1":"Time2"})`},a)}else return e.jsx(ve,{dataKey:a,fill:v((o+c)%12)},a)})]})});case"line":default:return e.jsx(me,{width:"100%",height:"100%",children:e.jsxs(Be,{...r,children:[n,i.map((a,c)=>{if(u&&a.includes("_Time")){const j=a.replace("_Time1","").replace("_Time2",""),h=a.includes("_Time1");return e.jsx(ge,{type:"monotone",dataKey:a,stroke:v((o+c)%12),strokeWidth:2,strokeDasharray:h?void 0:"5 5",name:`${j} (${h?"Time1":"Time2"})`},a)}else return e.jsx(ge,{type:"monotone",dataKey:a,stroke:v((o+c)%12),strokeWidth:2},a)})]})})}},[K,le,ae,u,v]),ke=l.useCallback(s=>{const d=Array.isArray(U[s])?U[s]:[],o=u&&z?Array.isArray(z[s])?z[s]:[]:[];if(d.length===0&&o.length===0)return[];if(se==="byPeg"){const i={};return d.forEach(r=>{const n=new Date(r.timestamp).toLocaleTimeString("ko-KR",{hour:"2-digit",minute:"2-digit"});i[n]||(i[n]={time:n});const a=u?`${r.entity_id}_Time1`:r.entity_id;i[n][a]=r.value}),u&&o.forEach(r=>{const n=new Date(r.timestamp).toLocaleTimeString("ko-KR",{hour:"2-digit",minute:"2-digit"});i[n]||(i[n]={time:n});const a=`${r.entity_id}_Time2`;i[n][a]=r.value}),Object.values(i)}else{const i={};d.forEach(n=>{const a=new Date(n.timestamp).toLocaleString(),c=n.entity_id;i[c]=i[c]||{},i[c][a]=i[c][a]||{time:a},i[c][a][n.peg_name]=n.value});const r={};return Object.keys(i).forEach(n=>{r[n]=Object.values(i[n]).sort((a,c)=>new Date(a.time)-new Date(c.time))}),r}},[U,z,u,se]);return T?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-3xl font-bold",children:"Dashboard"}),e.jsxs("div",{className:"flex items-center gap-2",children:[fe&&e.jsxs(x,{variant:"secondary",className:"text-xs",children:[e.jsx(oe,{className:"h-3 w-3 mr-1"}),"설정 저장 중"]}),pe&&e.jsx(x,{variant:"destructive",className:"text-xs",children:"설정 오류"})]})]}),e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:p.map(s=>e.jsxs(S,{children:[e.jsx(Z,{children:e.jsxs(J,{className:"flex items-center justify-between",children:[ie(s),e.jsx(x,{variant:"outline",className:"text-xs",children:K})]})}),e.jsx(B,{children:e.jsx("div",{className:"h-64 flex items-center justify-center",children:e.jsx("div",{className:"text-muted-foreground",children:"Loading..."})})})]},s))})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs(S,{children:[e.jsx(Z,{children:e.jsxs(J,{className:"flex items-center gap-2",children:[e.jsx(qe,{className:"h-5 w-5"}),"기본시간 설정"]})}),e.jsxs(B,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(A,{htmlFor:"defaultTimeRange",className:"text-sm font-medium",children:"기본 시간 범위"}),e.jsxs(Re,{value:Ce.toString(),onValueChange:Ee,children:[e.jsx(_e,{children:e.jsx(Ie,{placeholder:"시간 범위 선택"})}),e.jsxs(Pe,{children:[e.jsx(b,{value:"5",children:"5분"}),e.jsx(b,{value:"15",children:"15분"}),e.jsx(b,{value:"30",children:"30분"}),e.jsx(b,{value:"60",children:"1시간"}),e.jsx(b,{value:"120",children:"2시간"}),e.jsx(b,{value:"360",children:"6시간"}),e.jsx(b,{value:"720",children:"12시간"})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Me,{id:"enableTimeComparison",checked:u,onCheckedChange:be}),e.jsx(A,{htmlFor:"enableTimeComparison",className:"text-sm font-medium",children:"Time1/Time2 비교 활성화"})]}),u&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"text-sm font-medium text-blue-600",children:"Time1 설정"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx(A,{htmlFor:"time1Start",className:"text-xs text-muted-foreground",children:"시작 시간"}),e.jsx("input",{type:"datetime-local",id:"time1Start",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",value:m.time1Start,onChange:s=>Y("time1","Start",s.target.value)})]}),e.jsxs("div",{children:[e.jsx(A,{htmlFor:"time1End",className:"text-xs text-muted-foreground",children:"끝 시간"}),e.jsx("input",{type:"datetime-local",id:"time1End",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",value:m.time1End,onChange:s=>Y("time1","End",s.target.value)})]}),e.jsx(F,{onClick:we,disabled:!m.time1Start||!m.time1End||f.time1,size:"sm",className:"w-full bg-blue-600 hover:bg-blue-700 text-white",children:f.time1?e.jsxs(e.Fragment,{children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),"Time1 설정 완료"]}):"Time1 설정 입력"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"text-sm font-medium text-green-600",children:"Time2 설정"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx(A,{htmlFor:"time2Start",className:"text-xs text-muted-foreground",children:"시작 시간"}),e.jsx("input",{type:"datetime-local",id:"time2Start",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",value:m.time2Start,onChange:s=>Y("time2","Start",s.target.value)})]}),e.jsxs("div",{children:[e.jsx(A,{htmlFor:"time2End",className:"text-xs text-muted-foreground",children:"끝 시간"}),e.jsx("input",{type:"datetime-local",id:"time2End",className:"w-full px-2 py-1 border border-gray-300 rounded text-xs",value:m.time2End,onChange:s=>Y("time2","End",s.target.value)})]}),e.jsx(F,{onClick:De,disabled:!m.time2Start||!m.time2End||f.time2,size:"sm",className:"w-full bg-green-600 hover:bg-green-700 text-white",children:f.time2?e.jsxs(e.Fragment,{children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),"Time2 설정 완료"]}):"Time2 설정 입력"})]})]})]}),e.jsx("div",{className:"flex justify-center",children:e.jsx(F,{onClick:ne,disabled:T||!f.time1||!f.time2,className:"bg-purple-600 hover:bg-purple-700 text-white",children:T?"데이터 로딩 중...":"Time1/Time2 비교 데이터 로드"})}),e.jsxs("div",{className:"flex justify-center gap-4 text-xs",children:[e.jsxs("div",{className:`flex items-center gap-1 ${f.time1?"text-green-600":"text-gray-500"}`,children:[f.time1?e.jsx(Q,{className:"h-3 w-3"}):e.jsx(ye,{className:"h-3 w-3"}),"Time1 설정 ",f.time1?"완료":"대기"]}),e.jsxs("div",{className:`flex items-center gap-1 ${f.time2?"text-green-600":"text-gray-500"}`,children:[f.time2?e.jsx(Q,{className:"h-3 w-3"}):e.jsx(ye,{className:"h-3 w-3"}),"Time2 설정 ",f.time2?"완료":"대기"]})]})]})]}),!u&&e.jsx(F,{onClick:ne,disabled:T,className:"w-full",children:T?"데이터 로딩 중...":"데이터 새로고침"})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-bold",children:"Dashboard"}),e.jsxs("p",{className:"text-muted-foreground",children:[p.length,"개 PEG 항목 • 차트 스타일: ",K,u&&" • Time1/Time2 비교 모드",X&&` • NE: ${X}`,q&&` • Cell: ${q}`]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[fe&&e.jsxs(x,{variant:"secondary",className:"text-xs",children:[e.jsx(oe,{className:"h-3 w-3 mr-1"}),"설정 저장 중"]}),pe&&e.jsx(x,{variant:"destructive",className:"text-xs",children:"설정 오류"}),u&&e.jsx(x,{variant:"default",className:"text-xs bg-blue-100 text-blue-800",children:"Time1/Time2 비교"}),g>0&&ue>0&&e.jsxs(x,{variant:"outline",className:"text-xs",children:[e.jsx(oe,{className:"h-3 w-3 mr-1"}),ue,"초 후 새로고침"]}),de&&e.jsxs(x,{variant:"secondary",className:"text-xs",children:["마지막 업데이트: ",de.toLocaleTimeString()]}),e.jsxs(F,{variant:"outline",size:"sm",onClick:ne,disabled:T,children:[e.jsx(Ye,{className:`h-4 w-4 mr-2 ${T?"animate-spin":""}`}),"새로고침"]})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(x,{variant:"default",children:["선택된 PEG: ",p.join(", ")]}),u&&e.jsx(x,{variant:"default",className:"bg-blue-100 text-blue-800",children:"Time1/Time2 비교 활성화"}),g>0&&e.jsxs(x,{variant:"outline",children:["자동 새로고침: ",g,"초"]}),e.jsxs(x,{variant:"outline",children:["차트 스타일: ",K]}),!ae&&e.jsx(x,{variant:"secondary",children:"범례 숨김"}),!le&&e.jsx(x,{variant:"secondary",children:"격자 숨김"})]}),e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:p.map((s,d)=>{const o=ke(s);if(se==="byPeg"){const i=Array.isArray(o)?o:[],r=i.length>0?Object.keys(i[0]).filter(n=>n!=="time"):[];return e.jsxs(S,{children:[e.jsx(Z,{children:e.jsxs(J,{className:"flex items-center justify-between",children:[ie(s),e.jsxs("div",{className:"flex items-center gap-2",children:[u&&e.jsx(x,{variant:"default",className:"text-xs bg-blue-100 text-blue-800",children:"Time1/Time2 비교"}),e.jsxs(x,{variant:"outline",className:"text-xs",children:[r.length,"개 시리즈"]}),e.jsxs(x,{variant:"secondary",className:"text-xs",children:[i.length,"개 데이터포인트"]})]})]})}),e.jsx(B,{children:e.jsx("div",{className:"h-64 cursor-zoom-in",onClick:()=>te({open:!0,title:ie(s),data:i}),children:i.length>0?re(i,s,d):e.jsx("div",{className:"h-full flex items-center justify-center text-muted-foreground",children:"데이터가 없습니다"})})})]},`${s}-${d}`)}else{const i=o||{};return Object.keys(i).map((r,n)=>{const a=i[r],c=a.length>0?Object.keys(a[0]).filter(j=>j!=="time"):[];return e.jsxs(S,{children:[e.jsx(Z,{children:e.jsxs(J,{className:"flex items-center justify-between",children:[r,e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(x,{variant:"outline",className:"text-xs",children:[c.length,"개 시리즈"]}),e.jsxs(x,{variant:"secondary",className:"text-xs",children:[a.length,"개 데이터포인트"]})]})]})}),e.jsx(B,{children:e.jsx("div",{className:"h-64 cursor-zoom-in",onClick:()=>te({open:!0,title:r,data:a}),children:a.length>0?re(a,`${s}-${r}`,d+n):e.jsx("div",{className:"h-full flex items-center justify-center text-muted-foreground",children:"데이터가 없습니다"})})})]},`${s}-${r}-${n}`)})}})}),e.jsx($e,{open:O.open,onOpenChange:s=>te(d=>({...d,open:s})),children:e.jsxs(Ae,{className:"max-w-6xl",children:[e.jsx(Oe,{children:e.jsx(Le,{children:O.title})}),e.jsx("div",{className:"h-[480px]",children:Array.isArray(O.data)&&O.data.length>0&&re(O.data,"zoom",0)})]})}),p.length===0&&e.jsx(S,{children:e.jsx(B,{className:"pt-6",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Ze,{className:"h-12 w-12 mx-auto text-muted-foreground mb-4"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"표시할 PEG가 선택되지 않았습니다"}),e.jsx("p",{className:"text-muted-foreground",children:"Preference 메뉴에서 표시할 PEG 항목을 선택하세요."})]})})})]})};export{it as default};
