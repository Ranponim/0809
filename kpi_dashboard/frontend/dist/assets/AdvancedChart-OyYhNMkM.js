import{r as d,M as e}from"./vendor-D_Wz334c.js";import{L as h,e as O,h as $,i as M,j as q,k as z,l as J,I,x as R,a as L,C as U,b as Y,c as X,d as H}from"./index-BAtDSpDQ.js";import{T as te,C as re}from"./icon-vendor-DhUEaqm7.js";import{R as ne,a as le,C as ie,X as de,Y as Q,T as oe,L as ce,e as he,b as Z}from"./chart-vendor-C0q5LQDY.js";import"./utils-vendor-DrCDvq1f.js";import"./ui-vendor-D1gbbhYx.js";const ee=d.memo(({chartConfig:s,onConfigChange:u,kpiOptions:f,loading:C,onGenerate:b,useDbPegs:m,onToggleDbPegs:w,pegOptionsLoading:g,dbPegOptions:x})=>{const n=(a,P)=>{u(D=>({...D,[a]:P}))},o=()=>{var a,P;try{const D=localStorage.getItem("activePreference");if(!D)return;const p=JSON.parse(D),K=Array.isArray((a=p==null?void 0:p.config)==null?void 0:a.defaultNEs)?p.config.defaultNEs.map(String):[],G=Array.isArray((P=p==null?void 0:p.config)==null?void 0:P.defaultCellIDs)?p.config.defaultCellIDs.map(String):[];u(B=>({...B,ne:K.join(","),cellid:G.join(",")}))}catch{}},S=()=>m&&x.length>0?x:f;return e.jsxs("div",{children:[e.jsxs("div",{className:"mb-4 p-4 border rounded-lg bg-muted/50",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(h,{className:"text-sm font-medium",children:"PEG 데이터 소스"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:m?"Database에서 실제 PEG 목록을 사용합니다":"기본 KPI 목록을 사용합니다"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{variant:m?"secondary":"default",size:"sm",onClick:()=>w(!1),children:"기본 KPI"}),e.jsx(O,{variant:m?"default":"secondary",size:"sm",onClick:()=>w(!0),disabled:g,children:g?"로딩 중...":"DB PEG"})]})]}),m&&x.length===0&&!g&&e.jsx("p",{className:"text-xs text-amber-600 mt-2",children:"⚠️ DB PEG를 불러올 수 없습니다. Database Settings를 확인하세요."}),m&&x.length>0&&e.jsxs("p",{className:"text-xs text-green-600 mt-2",children:["✅ ",x.length,"개의 DB PEG를 사용할 수 있습니다"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Primary KPI"}),e.jsxs($,{value:s.primaryKPI,onValueChange:a=>n("primaryKPI",a),children:[e.jsx(M,{children:e.jsx(q,{})}),e.jsx(z,{children:S().map(a=>e.jsx(J,{value:a.value,children:a.label},a.value))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Secondary KPI (Dual Axis)"}),e.jsxs($,{value:s.secondaryKPI,onValueChange:a=>n("secondaryKPI",a),disabled:!s.showSecondaryAxis,children:[e.jsx(M,{children:e.jsx(q,{})}),e.jsx(z,{children:S().map(a=>e.jsx(J,{value:a.value,children:a.label},a.value))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Period 1 Start"}),e.jsx(I,{type:"date",value:s.startDate1,onChange:a=>n("startDate1",a.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Period 1 End"}),e.jsx(I,{type:"date",value:s.endDate1,onChange:a=>n("endDate1",a.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Period 2 Start"}),e.jsx(I,{type:"date",value:s.startDate2,onChange:a=>n("startDate2",a.target.value),disabled:!s.showComparison})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Period 2 End"}),e.jsx(I,{type:"date",value:s.endDate2,onChange:a=>n("endDate2",a.target.value),disabled:!s.showComparison})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"NE"}),e.jsx(I,{placeholder:"e.g., nvgnb#10000 or nvgnb#10000,nvgnb#20000",value:s.ne,onChange:a=>n("ne",a.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Cell ID"}),e.jsx(I,{placeholder:"e.g., 2010 or 2010,2011",value:s.cellid,onChange:a=>n("cellid",a.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Use Preference (NE/Cell)"}),e.jsx(O,{type:"button",variant:"outline",onClick:o,children:"Load from Preference"})]})]}),e.jsxs("div",{className:"mt-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(R,{id:"showComparison",checked:s.showComparison,onCheckedChange:a=>n("showComparison",a)}),e.jsx(h,{htmlFor:"showComparison",children:"Show Period Comparison"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(R,{id:"showSecondaryAxis",checked:s.showSecondaryAxis,onCheckedChange:a=>n("showSecondaryAxis",a)}),e.jsx(h,{htmlFor:"showSecondaryAxis",children:"Show Secondary Y-Axis"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(R,{id:"showThreshold",checked:s.showThreshold,onCheckedChange:a=>n("showThreshold",a)}),e.jsx(h,{htmlFor:"showThreshold",children:"Show Threshold Line"})]}),s.showThreshold&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(h,{htmlFor:"threshold",children:"Threshold Value:"}),e.jsx(I,{id:"threshold",type:"number",step:"0.1",value:s.thresholdValue,onChange:a=>n("thresholdValue",parseFloat(a.target.value)),className:"w-24"})]})]}),e.jsx("div",{className:"mt-4",children:e.jsxs(O,{onClick:b,disabled:C,className:"flex items-center gap-2",children:[e.jsx(te,{className:"h-4 w-4"}),C?"Generating...":"Generate Chart"]})})]})});ee.displayName="ChartControls";const ae=d.memo(({chartData:s,chartConfig:u,loading:f,kpiOptions:C,useDbPegs:b,dbPegOptions:m})=>{const w=d.useMemo(()=>{if(s.length===0)return{primary:[],secondary:[]};const n=Object.keys(s[0]).filter(a=>a!=="time"),o=n.filter(a=>a.endsWith("_period1")||a.endsWith("_period2")),S=n.filter(a=>a.endsWith("_secondary"));return{primary:o,secondary:S}},[s]);d.useMemo(()=>b&&m.length>0?m:C,[b,m,C]);const{primary:g,secondary:x}=w;return s.length===0?e.jsx("div",{className:"flex items-center justify-center h-96 text-gray-500",children:f?"Generating chart...":'Click "Generate Chart" to create visualization'}):e.jsx("div",{className:"h-96",children:e.jsx(ne,{width:"100%",height:"100%",children:e.jsxs(le,{data:s,children:[e.jsx(ie,{strokeDasharray:"3 3"}),e.jsx(de,{dataKey:"time"}),e.jsx(Q,{yAxisId:"left"}),u.showSecondaryAxis&&e.jsx(Q,{yAxisId:"right",orientation:"right"}),e.jsx(oe,{}),e.jsx(ce,{}),u.showThreshold&&e.jsx(he,{y:u.thresholdValue,stroke:"red",strokeDasharray:"5 5",yAxisId:"left"}),g.map((n,o)=>e.jsx(Z,{yAxisId:"left",type:"monotone",dataKey:n,stroke:n.includes("period1")?`hsl(${o*60}, 70%, 40%)`:`hsl(${o*60}, 70%, 60%)`,strokeWidth:2,strokeDasharray:n.includes("period1")?"0":"5 5"},n)),u.showSecondaryAxis&&x.map((n,o)=>e.jsx(Z,{yAxisId:"right",type:"monotone",dataKey:n,stroke:`hsl(${(o+g.length)*60}, 70%, 50%)`,strokeWidth:2,strokeDasharray:"10 5"},n))]})})})});ae.displayName="ChartDisplay";const V=[{value:"availability",label:"Availability (%)",threshold:99},{value:"rrc",label:"RRC Success Rate (%)",threshold:98.5},{value:"erab",label:"ERAB Success Rate (%)",threshold:99},{value:"sar",label:"SAR",threshold:2.5},{value:"mobility_intra",label:"Mobility Intra (%)",threshold:95},{value:"cqi",label:"CQI",threshold:8}],me=d.memo(()=>{var F,W;const[s,u]=d.useState({primaryKPI:"availability",secondaryKPI:"rrc",startDate1:new Date(Date.now()-12096e5).toISOString().split("T")[0],endDate1:new Date(Date.now()-6048e5).toISOString().split("T")[0],startDate2:new Date(Date.now()-6048e5).toISOString().split("T")[0],endDate2:new Date().toISOString().split("T")[0],ne:"",cellid:"",showSecondaryAxis:!0,showComparison:!0,showThreshold:!0,thresholdValue:99}),[f,C]=d.useState([]),[b,m]=d.useState(!1),[w,g]=d.useState(!1),[x,n]=d.useState(V),[o,S]=d.useState([]),[a,P]=d.useState(!1),D=d.useMemo(()=>a&&o.length>0?o:x,[a,o,x]),p=d.useMemo(()=>{if(f.length===0)return{primary:[],secondary:[]};const r=Object.keys(f[0]).filter(l=>l!=="time"),i=r.filter(l=>l.endsWith("_period1")||l.endsWith("_period2")),c=r.filter(l=>l.endsWith("_secondary"));return{primary:i,secondary:c}},[f]),K=d.useCallback(async()=>{var r;try{g(!0),console.info("[AdvancedChart] Fetching DB PEGs");let i={};try{const t=localStorage.getItem("dbConfig");t&&(i=JSON.parse(t))}catch{}if(!i.host){console.warn("[AdvancedChart] No DB config found");return}const c=await L.post("/api/master/pegs",{db:i,table:i.table||"summary",limit:100}),l=((r=c==null?void 0:c.data)==null?void 0:r.pegs)||[];console.info("[AdvancedChart] DB PEGs loaded:",l.length);const j=l.map(t=>({value:t.id||t.name,label:`${t.name||t.id} (DB)`,threshold:0,isDbPeg:!0}));S(j)}catch(i){console.error("[AdvancedChart] Error fetching DB PEGs:",i)}finally{g(!1)}},[]),G=d.useCallback((r,i)=>{var E,T;if(!r||r.length===0)return[];const c=((T=(E=r[0])==null?void 0:E.data)==null?void 0:T.data)||[],l=i.showComparison&&r[1]?r[1].data.data:[],j=i.showSecondaryAxis&&r[2]?r[2].data.data:[],t={};function N(A,_){const y={};A.forEach(v=>{const k=new Date(v.timestamp).toLocaleString();y[k]||(y[k]={sum:0,cnt:0}),y[k].sum+=Number(v.value)||0,y[k].cnt+=1}),Object.keys(y).forEach(v=>{t[v]||(t[v]={time:v});const k=y[v].cnt>0?+(y[v].sum/y[v].cnt).toFixed(2):0;t[v][_]=k})}return N(c,`${i.primaryKPI}_period1`),i.showComparison&&N(l,`${i.primaryKPI}_period2`),i.showSecondaryAxis&&N(j,`${i.secondaryKPI}_secondary`),Object.values(t).sort((A,_)=>new Date(A.time)-new Date(_.time)).slice(0,200)},[]),B=d.useCallback(async()=>{try{m(!0),console.info("[AdvancedChart] Generate with config:",s,"useDbPegs:",a);const r=[];r.push(L.post("/api/kpi/query",{start_date:s.startDate1,end_date:s.endDate1,kpi_type:s.primaryKPI,ne:s.ne,cellid:s.cellid,ids:2})),s.showComparison&&r.push(L.post("/api/kpi/query",{start_date:s.startDate2,end_date:s.endDate2,kpi_type:s.primaryKPI,ne:s.ne,cellid:s.cellid,ids:2})),s.showSecondaryAxis&&s.secondaryKPI!==s.primaryKPI&&r.push(L.post("/api/kpi/query",{start_date:s.startDate2,end_date:s.endDate2,kpi_type:s.secondaryKPI,ne:s.ne,cellid:s.cellid,ids:2}));const i=await Promise.all(r);console.info("[AdvancedChart] API responses:",i.map(l=>{var j,t;return((t=(j=l==null?void 0:l.data)==null?void 0:j.data)==null?void 0:t.length)??0}));const c=G(i,s);C(c)}catch(r){console.error("[AdvancedChart] Error generating advanced chart:",r)}finally{m(!1)}},[s,a,G]),se=d.useCallback(r=>{P(r),r&&o.length===0&&K()},[o.length,K]);d.useEffect(()=>{var r;try{const i=localStorage.getItem("activePreference");if(i){const c=JSON.parse(i),l=Array.isArray((r=c==null?void 0:c.config)==null?void 0:r.availableKPIs)&&c.config.availableKPIs.length>0?c.config.availableKPIs.map(t=>({value:String(t.value),label:String(t.label||t.value),threshold:Number(t.threshold??0)})):V;n(l);const j=l.map(t=>t.value);u(t=>{var N,E,T,A;return{...t,primaryKPI:j.includes(t.primaryKPI)?t.primaryKPI:((N=l[0])==null?void 0:N.value)||"availability",secondaryKPI:j.includes(t.secondaryKPI)?t.secondaryKPI:((E=l[1])==null?void 0:E.value)||((T=l[0])==null?void 0:T.value)||"rrc",thresholdValue:((A=l.find(_=>{var y;return _.value===(j.includes(t.primaryKPI)?t.primaryKPI:((y=l[0])==null?void 0:y.value)||"availability")}))==null?void 0:A.threshold)??t.thresholdValue}})}}catch{n(V)}},[]),d.useEffect(()=>{a&&o.length===0&&K()},[a,o.length,K]);const{primary:xe,secondary:ye}=p;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(U,{children:[e.jsx(Y,{children:e.jsxs(X,{className:"flex items-center gap-2",children:[e.jsx(re,{className:"h-5 w-5"}),"Advanced Chart Configuration"]})}),e.jsx(H,{children:e.jsx(ee,{chartConfig:s,onConfigChange:u,kpiOptions:x,loading:b,onGenerate:B,useDbPegs:a,onToggleDbPegs:se,pegOptionsLoading:w,dbPegOptions:o})})]}),e.jsxs(U,{children:[e.jsx(Y,{children:e.jsxs(X,{children:[((F=D.find(r=>r.value===s.primaryKPI))==null?void 0:F.label)||"KPI"," Analysis",s.showSecondaryAxis&&` vs ${(W=D.find(r=>r.value===s.secondaryKPI))==null?void 0:W.label}`]})}),e.jsx(H,{children:e.jsx(ae,{chartData:f,chartConfig:s,loading:b,kpiOptions:x,useDbPegs:a,dbPegOptions:o})})]})]})});me.displayName="AdvancedChart";export{me as default};
