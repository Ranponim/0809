import{r as c,M as e,a3 as g}from"./vendor-CIPdjx1t.js";import{a as V,B as b,i as N,F as K,C as x,b as Q,c as U,d as h,L as y,S as me,e as xe,f as he,g as ue,h as D,T as ge,m as je,n as H,o as J}from"./index-Q594mB1I.js";import{S as W}from"./separator-DidKRWFN.js";import{S as pe}from"./scroll-area-ZOOfn5zd.js";import f from"./ComparisonChart-Dm_WdRJP.js";import{b as be,a as fe}from"./usePreference-BdPvxwX6.js";import{C as ve}from"./checkbox-DNwZZDik.js";import{R as X,P as Ne,S as ye,D as De,k as Y,E as Se,C as Z,r as Ce,M as Pe,N as we,a as _e}from"./icon-vendor-CWV3Q6sV.js";import"./utils-vendor-DrCDvq1f.js";import"./ui-vendor-C5A5DcrM.js";import"./chart-vendor-CWmmjCk1.js";const Le=()=>{var O,B,L,M,F,q;const{settings:i}=be(),{updatePreference:ee,isSaving:_}=fe(),[o,S]=c.useState({startDate:"",endDate:"",preset:"last7days"}),[m,C]=c.useState({startDate:"",endDate:"",preset:"last14days"}),[u,v]=c.useState(["availability","rrc","erab"]),[j,E]=c.useState(!0),[P,T]=c.useState(4),[r,se]=c.useState(null),[I,A]=c.useState(!1),[w,G]=c.useState(null),[R,ae]=c.useState(null),[d,p]=c.useState(new Set),k=c.useMemo(()=>i!=null&&i.table?[{value:"availability",label:"Availability (%)"},{value:"rrc",label:"RRC Success Rate (%)"},{value:"erab",label:"ERAB Success Rate (%)"},{value:"sar",label:"SAR"},{value:"mobility_intra",label:"Mobility Intra (%)"},{value:"cqi",label:"CQI"}]:[],[i==null?void 0:i.table]),$=c.useCallback(async()=>{console.log("🔍 Available PEGs 로드 시작");try{const s=localStorage.getItem("dbConfig"),a=localStorage.getItem("useDbPegs")==="true";console.log("📊 DB 설정 상태:",{hasDbConfig:!!s,useDbPegs:a,dbConfigData:s?JSON.parse(s):null});let t=[];if(a&&s){console.log("🔗 Database에서 PEG 목록 조회 중...");const l=await V.get("/api/master/pegs");console.log("📥 Database PEG 응답:",l.data),l.data&&Array.isArray(l.data)&&(t=l.data.map(n=>({value:n.peg_name||n.value||n.id,label:n.display_name||n.label||`${n.peg_name} (${n.unit||"N/A"})`})))}if(t.length===0&&(console.log("📝 기본 PEG 목록 사용"),t=[{value:"availability",label:"Availability (%)"},{value:"rrc",label:"RRC Success Rate (%)"},{value:"erab",label:"ERAB Success Rate (%)"},{value:"sar",label:"SAR"},{value:"mobility_intra",label:"Mobility Intra (%)"},{value:"cqi",label:"CQI"},{value:"se",label:"Spectral Efficiency"},{value:"dl_thp",label:"DL Throughput"},{value:"ul_int",label:"UL Interference"}]),console.log("✅ PEG 목록 로드 완료:",t),u.length===0&&t.length>0){const l=t.slice(0,3).map(n=>n.value);v(l),console.log("🎯 기본 PEG 선택:",l)}}catch(s){console.error("❌ PEG 목록 로드 실패:",s)}finally{}},[u.length]);c.useEffect(()=>{const s=new Date,a=new Date(s),t=new Date(s.getTime()-10080*60*1e3),l=new Date(t),n=new Date(t.getTime()-10080*60*1e3);S({startDate:t.toISOString().split("T")[0],endDate:a.toISOString().split("T")[0],preset:"last7days"}),C({startDate:n.toISOString().split("T")[0],endDate:l.toISOString().split("T")[0],preset:"custom"}),$()},[$]),c.useEffect(()=>{i.defaultPegs&&v(i.defaultPegs),i.decimalPlaces!==void 0&&T(i.decimalPlaces),i.includeOutliers!==void 0&&E(i.includeOutliers)},[i]);const te=c.useCallback(({startDate:s,endDate:a})=>{S(t=>({...t,startDate:s,endDate:a,preset:"custom"}))},[]),le=c.useCallback(({startDate:s,endDate:a})=>{C(t=>({...t,startDate:s,endDate:a,preset:"custom"}))},[]),re=async()=>{var s,a,t;if(!o.startDate||!o.endDate||!m.startDate||!m.endDate){g.error("두 기간의 날짜를 모두 설정해주세요");return}if(u.length===0){g.error("분석할 PEG를 최소 1개 이상 선택해주세요");return}A(!0),G(null);try{console.log("🔍 Statistics 비교 분석 시작:",{period1:o,period2:m,selectedPegs:u,includeOutliers:j,decimalPlaces:P});const l={period1:{start_date:`${o.startDate}T00:00:00`,end_date:`${o.endDate}T23:59:59`},period2:{start_date:`${m.startDate}T00:00:00`,end_date:`${m.endDate}T23:59:59`},peg_names:u,include_outliers:j,decimal_places:P,ne_filter:i.defaultNe?[i.defaultNe]:null,cell_id_filter:i.defaultCellId?[i.defaultCellId]:null};console.log("📤 API 요청 페이로드:",l);const n=await V.post("/api/statistics/compare",l);console.log("📥 API 응답:",n.data),se(n.data),ae(new Date),g.success(`비교 분석 완료! ${((s=n.data.analysis_results)==null?void 0:s.length)||0}개 PEG 분석됨`)}catch(l){console.error("❌ 비교 분석 실패:",l);let n="비교 분석 중 오류가 발생했습니다";(t=(a=l.response)==null?void 0:a.data)!=null&&t.error_message?n=l.response.data.error_message:l.message&&(n=l.message),G(n),g.error(n)}finally{A(!1)}},ne=s=>{const a=new Set(d);a.has(s)?a.delete(s):a.add(s),p(a)},ie=()=>{var s,a;if(d.size===((s=r==null?void 0:r.analysis_results)==null?void 0:s.length))p(new Set);else{const t=((a=r==null?void 0:r.analysis_results)==null?void 0:a.map(l=>l.peg_name))||[];p(new Set(t))}},ce=async()=>{if(d.size===0){g.error("저장할 PEG를 선택해주세요");return}try{console.log("💾 Dashboard에 저장할 PEG:",Array.from(d));const s=dashboardSettings||{},a=(s==null?void 0:s.selectedPegs)||[],t=Array.from(d).filter(n=>!a.includes(n)),l=[...a,...t];console.log("📊 현재 Dashboard PEG:",a),console.log("🆕 추가할 새 PEG:",t),console.log("📈 업데이트된 PEG 목록:",l),await ee("dashboardSettings",{...s,selectedPegs:l}),g.success(`${d.size}개 PEG가 Dashboard에 추가되었습니다`,{description:`총 ${l.length}개 PEG가 Dashboard에 설정되어 있습니다. Dashboard로 이동해서 확인해보세요!`,duration:5e3}),p(new Set)}catch(s){console.error("❌ Dashboard 저장 실패:",s),g.error("Dashboard 저장 중 오류가 발생했습니다",{description:s.message||"네트워크 오류일 수 있습니다"})}},z=o.startDate&&o.endDate&&m.startDate&&m.endDate&&u.length>0,de=s=>{switch(s){case"improved":return e.jsx(_e,{className:"h-4 w-4 text-green-500"});case"degraded":return e.jsx(we,{className:"h-4 w-4 text-red-500"});case"stable":return e.jsx(Pe,{className:"h-4 w-4 text-blue-500"});default:return e.jsx(Y,{className:"h-4 w-4 text-yellow-500"})}},oe=(s,a)=>{const t={improved:"bg-green-100 text-green-800 border-green-200",degraded:"bg-red-100 text-red-800 border-red-200",stable:"bg-blue-100 text-blue-800 border-blue-200"},l={significant:"상당한",moderate:"보통",minor:"미미한",none:"변화없음"};return e.jsxs(b,{className:`${t[s]||"bg-gray-100 text-gray-800"} text-xs`,children:[de(s),e.jsxs("span",{className:"ml-1",children:[s==="improved"?"개선":s==="degraded"?"악화":"안정",a&&` (${l[a]})`]})]})};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Basic 비교 분석"}),e.jsx("p",{className:"text-muted-foreground",children:"두 기간의 KPI 데이터를 비교하여 성능 변화를 분석합니다"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[R&&e.jsxs(b,{variant:"outline",className:"text-xs",children:["마지막 분석: ",R.toLocaleTimeString("ko-KR")]}),e.jsx(N,{onClick:re,disabled:!z||I,className:"bg-blue-600 hover:bg-blue-700",children:I?e.jsxs(e.Fragment,{children:[e.jsx(X,{className:"h-4 w-4 mr-2 animate-spin"}),"분석 중..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ne,{className:"h-4 w-4 mr-2"}),"비교 분석 실행"]})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx(K,{title:"기간 1 (기준)",description:"비교의 기준이 되는 첫 번째 기간",startDate:o.startDate,endDate:o.endDate,preset:o.preset,onDateChange:te,onPresetChange:s=>S(a=>({...a,preset:s}))}),e.jsx(K,{title:"기간 2 (비교 대상)",description:"기준과 비교할 두 번째 기간",startDate:m.startDate,endDate:m.endDate,preset:m.preset,onDateChange:le,onPresetChange:s=>C(a=>({...a,preset:s}))}),e.jsxs(x,{children:[e.jsx(Q,{className:"pb-3",children:e.jsxs(U,{className:"flex items-center gap-2 text-base",children:[e.jsx(ye,{className:"h-4 w-4"}),"분석 옵션"]})}),e.jsxs(h,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{className:"text-sm font-medium flex items-center justify-between",children:e.jsx("span",{children:"분석할 PEG"})}),e.jsx("div",{className:"space-y-2 max-h-32 overflow-y-auto",children:k.length>0?k.map(s=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ve,{id:`peg-${s.value}`,checked:u.includes(s.value),onCheckedChange:a=>{v(a?t=>[...t,s.value]:t=>t.filter(l=>l!==s.value))}}),e.jsx(y,{htmlFor:`peg-${s.value}`,className:"text-sm cursor-pointer flex-1",children:s.label})]},s.value)):e.jsxs("div",{className:"text-center text-muted-foreground py-4",children:[e.jsx(De,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:"사용 가능한 PEG가 없습니다"}),e.jsx("p",{className:"text-xs",children:"Database 설정을 확인해주세요"})]})}),e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs(b,{variant:"outline",className:"text-xs",children:[u.length,"개 선택됨"]})})]}),e.jsx(W,{}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(y,{className:"text-sm",children:"이상치 포함"}),e.jsx(N,{variant:j?"default":"outline",size:"sm",onClick:()=>E(!j),children:j?"포함":"제외"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{className:"text-sm",children:"소수점 자릿수"}),e.jsxs(me,{value:P.toString(),onValueChange:s=>T(parseInt(s)),children:[e.jsx(xe,{children:e.jsx(he,{})}),e.jsxs(ue,{children:[e.jsx(D,{value:"2",children:"2자리"}),e.jsx(D,{value:"3",children:"3자리"}),e.jsx(D,{value:"4",children:"4자리"}),e.jsx(D,{value:"5",children:"5자리"})]})]})]})]})]})]})]}),w&&e.jsx(x,{className:"border-red-200 bg-red-50",children:e.jsxs(h,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Y,{className:"h-5 w-5 text-red-500"}),e.jsx("span",{className:"text-red-700 font-medium",children:"분석 오류"})]}),e.jsx("p",{className:"text-red-600 mt-2",children:w})]})}),r&&e.jsxs("div",{className:"space-y-6",children:[e.jsx(W,{}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-semibold mb-4",children:"비교 분석 결과"}),e.jsx("div",{className:"mb-6",children:e.jsx(f,{comparisonResults:r,title:"PEG 비교 분석 차트",showControls:!0,defaultChartType:"bar",height:400})}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6",children:[e.jsx(x,{children:e.jsx(h,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:((O=r.summary)==null?void 0:O.total_pegs_analyzed)||0}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"분석된 PEG"})]})})}),e.jsx(x,{children:e.jsx(h,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:((B=r.summary)==null?void 0:B.improved_count)||0}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"개선"})]})})}),e.jsx(x,{children:e.jsx(h,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:((L=r.summary)==null?void 0:L.degraded_count)||0}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"악화"})]})})}),e.jsx(x,{children:e.jsx(h,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:((M=r.summary)==null?void 0:M.stable_count)||0}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"안정"})]})})})]}),e.jsxs(x,{children:[e.jsx(Q,{children:e.jsx(U,{children:"상세 비교 결과"})}),e.jsx(h,{children:e.jsxs(ge,{defaultValue:"table",className:"w-full",children:[e.jsxs(je,{className:"grid w-full grid-cols-2",children:[e.jsxs(H,{value:"table",className:"flex items-center gap-2",children:[e.jsx(Se,{className:"h-4 w-4"}),"테이블 뷰"]}),e.jsxs(H,{value:"chart",className:"flex items-center gap-2",children:[e.jsx(Z,{className:"h-4 w-4"}),"차트 뷰"]})]}),e.jsxs(J,{value:"table",className:"space-y-4",children:[((F=r==null?void 0:r.analysis_results)==null?void 0:F.length)>0&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-slate-50 border border-slate-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:d.size===r.analysis_results.length&&d.size>0,onChange:ie,className:"w-4 h-4 text-blue-600 rounded"}),e.jsxs("span",{className:"text-sm font-medium",children:["전체 선택 (",d.size,"/",r.analysis_results.length,")"]})]}),d.size>0&&e.jsxs(b,{variant:"secondary",className:"bg-blue-100 text-blue-700",children:[d.size,"개 선택됨"]})]}),d.size>0&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{variant:"outline",size:"sm",onClick:()=>p(new Set),children:"선택 해제"}),e.jsx(N,{size:"sm",onClick:ce,disabled:_,className:"bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400",children:_?e.jsxs(e.Fragment,{children:[e.jsx(X,{className:"h-3 w-3 mr-1 animate-spin"}),"저장 중..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ce,{className:"h-3 w-3 mr-1"}),"Dashboard에 저장"]})})]})]}),e.jsx(pe,{className:"h-96",children:e.jsx("div",{className:"space-y-4",children:(q=r.analysis_results)==null?void 0:q.map((s,a)=>{var t,l;return e.jsx(x,{className:`border-l-4 border-l-blue-500 ${d.has(s.peg_name)?"ring-2 ring-blue-500 bg-blue-50":""}`,children:e.jsxs(h,{className:"pt-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",checked:d.has(s.peg_name),onChange:()=>ne(s.peg_name),className:"w-4 h-4 text-blue-600 rounded"}),e.jsx("h4",{className:"font-semibold",children:s.peg_name})]}),oe(s.improvement_status,s.improvement_magnitude)]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"기간 1 평균"}),e.jsx("div",{className:"font-medium",children:(t=s.period1_stats)==null?void 0:t.mean})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"기간 2 평균"}),e.jsx("div",{className:"font-medium",children:(l=s.period2_stats)==null?void 0:l.mean})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Delta"}),e.jsxs("div",{className:`font-medium ${s.delta>0?"text-green-600":s.delta<0?"text-red-600":"text-blue-600"}`,children:[s.delta>0?"+":"",s.delta]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Delta %"}),e.jsxs("div",{className:`font-medium ${s.delta_percentage>0?"text-green-600":s.delta_percentage<0?"text-red-600":"text-blue-600"}`,children:[s.delta_percentage>0?"+":"",s.delta_percentage,"%"]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mt-3 pt-3 border-t text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"기간 1 RSD"}),e.jsxs("div",{className:"font-medium",children:[s.rsd_period1,"%"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"기간 2 RSD"}),e.jsxs("div",{className:"font-medium",children:[s.rsd_period2,"%"]})]})]})]})},a)})})})]}),e.jsx(J,{value:"chart",children:e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsx(f,{comparisonResults:r,title:"막대 차트",showControls:!1,defaultChartType:"bar",height:300}),e.jsx(f,{comparisonResults:r,title:"라인 차트",showControls:!1,defaultChartType:"line",height:300}),e.jsx(f,{comparisonResults:r,title:"개선 상태 분포",showControls:!1,defaultChartType:"pie",height:300}),e.jsx(f,{comparisonResults:r,title:"레이더 차트",showControls:!1,defaultChartType:"radar",height:300})]})})})]})})]})]})]}),!r&&!w&&e.jsx(x,{className:"text-center py-12",children:e.jsxs(h,{children:[e.jsx(Z,{className:"h-12 w-12 mx-auto text-muted-foreground mb-4"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"비교 분석 준비"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"두 기간과 분석할 PEG를 선택한 후 '비교 분석 실행' 버튼을 클릭하세요"}),e.jsx(b,{variant:"outline",children:z?"분석 준비 완료":"설정 필요"})]})})]})};export{Le as default};
