import{r as i,M as e}from"./vendor-CIPdjx1t.js";import{L as c,i as G,S as $,e as W,f as q,g as M,h as z,I as C,a as L,C as J,b as U,c as Y,d as X}from"./index-Q594mB1I.js";import{C as R}from"./checkbox-DNwZZDik.js";import{a as ae,C as se}from"./icon-vendor-CWV3Q6sV.js";import{R as te,L as re,C as le,X as ne,Y as H,T as ie,a as de,c as oe,b as Q}from"./chart-vendor-CWmmjCk1.js";import"./utils-vendor-DrCDvq1f.js";import"./ui-vendor-C5A5DcrM.js";const Z=i.memo(({chartConfig:s,onConfigChange:u,kpiOptions:P,loading:N,onGenerate:A,useDbPegs:y,onToggleDbPegs:b,pegOptionsLoading:g,dbPegOptions:m})=>{const r=(a,K)=>{u(f=>({...f,[a]:K}))},d=()=>{var a,K;try{const f=localStorage.getItem("activePreference");if(!f)return;const x=JSON.parse(f),O=Array.isArray((a=x==null?void 0:x.config)==null?void 0:a.defaultNEs)?x.config.defaultNEs.map(String):[],B=Array.isArray((K=x==null?void 0:x.config)==null?void 0:K.defaultCellIDs)?x.config.defaultCellIDs.map(String):[];u(_=>({..._,ne:O.join(","),cellid:B.join(",")}))}catch{}},S=()=>y&&m.length>0?m:P;return e.jsxs("div",{children:[e.jsxs("div",{className:"mb-4 p-4 border rounded-lg bg-muted/50",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(c,{className:"text-sm font-medium",children:"PEG 데이터 소스"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:y?"Database에서 실제 PEG 목록을 사용합니다":"기본 KPI 목록을 사용합니다"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(G,{variant:y?"secondary":"default",size:"sm",onClick:()=>b(!1),children:"기본 KPI"}),e.jsx(G,{variant:y?"default":"secondary",size:"sm",onClick:()=>b(!0),disabled:g,children:g?"로딩 중...":"DB PEG"})]})]}),y&&m.length===0&&!g&&e.jsx("p",{className:"text-xs text-amber-600 mt-2",children:"⚠️ DB PEG를 불러올 수 없습니다. Database Settings를 확인하세요."}),y&&m.length>0&&e.jsxs("p",{className:"text-xs text-green-600 mt-2",children:["✅ ",m.length,"개의 DB PEG를 사용할 수 있습니다"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{children:"Primary KPI"}),e.jsxs($,{value:s.primaryKPI,onValueChange:a=>r("primaryKPI",a),children:[e.jsx(W,{children:e.jsx(q,{})}),e.jsx(M,{children:S().map(a=>e.jsx(z,{value:a.value,children:a.label},a.value))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{children:"Secondary KPI (Dual Axis)"}),e.jsxs($,{value:s.secondaryKPI,onValueChange:a=>r("secondaryKPI",a),disabled:!s.showSecondaryAxis,children:[e.jsx(W,{children:e.jsx(q,{})}),e.jsx(M,{children:S().map(a=>e.jsx(z,{value:a.value,children:a.label},a.value))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{children:"Period 1 Start"}),e.jsx(C,{type:"date",value:s.startDate1,onChange:a=>r("startDate1",a.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{children:"Period 1 End"}),e.jsx(C,{type:"date",value:s.endDate1,onChange:a=>r("endDate1",a.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{children:"Period 2 Start"}),e.jsx(C,{type:"date",value:s.startDate2,onChange:a=>r("startDate2",a.target.value),disabled:!s.showComparison})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{children:"Period 2 End"}),e.jsx(C,{type:"date",value:s.endDate2,onChange:a=>r("endDate2",a.target.value),disabled:!s.showComparison})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{children:"NE"}),e.jsx(C,{placeholder:"e.g., nvgnb#10000 or nvgnb#10000,nvgnb#20000",value:s.ne,onChange:a=>r("ne",a.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{children:"Cell ID"}),e.jsx(C,{placeholder:"e.g., 2010 or 2010,2011",value:s.cellid,onChange:a=>r("cellid",a.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{children:"Use Preference (NE/Cell)"}),e.jsx(G,{type:"button",variant:"outline",onClick:d,children:"Load from Preference"})]})]}),e.jsxs("div",{className:"mt-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(R,{id:"showComparison",checked:s.showComparison,onCheckedChange:a=>r("showComparison",a)}),e.jsx(c,{htmlFor:"showComparison",children:"Show Period Comparison"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(R,{id:"showSecondaryAxis",checked:s.showSecondaryAxis,onCheckedChange:a=>r("showSecondaryAxis",a)}),e.jsx(c,{htmlFor:"showSecondaryAxis",children:"Show Secondary Y-Axis"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(R,{id:"showThreshold",checked:s.showThreshold,onCheckedChange:a=>r("showThreshold",a)}),e.jsx(c,{htmlFor:"showThreshold",children:"Show Threshold Line"})]}),s.showThreshold&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(c,{htmlFor:"threshold",children:"Threshold Value:"}),e.jsx(C,{id:"threshold",type:"number",step:"0.1",value:s.thresholdValue,onChange:a=>r("thresholdValue",parseFloat(a.target.value)),className:"w-24"})]})]}),e.jsx("div",{className:"mt-4",children:e.jsxs(G,{onClick:A,disabled:N,className:"flex items-center gap-2",children:[e.jsx(ae,{className:"h-4 w-4"}),N?"Generating...":"Generate Chart"]})})]})});Z.displayName="ChartControls";const ee=i.memo(({chartData:s,chartConfig:u,loading:P,kpiOptions:N,useDbPegs:A,dbPegOptions:y})=>{const b=i.useMemo(()=>{if(s.length===0)return{primary:[],secondary:[]};const r=Object.keys(s[0]).filter(a=>a!=="time"),d=r.filter(a=>a.endsWith("_period1")||a.endsWith("_period2")),S=r.filter(a=>a.endsWith("_secondary"));return{primary:d,secondary:S}},[s]),{primary:g,secondary:m}=b;return s.length===0?e.jsx("div",{className:"flex items-center justify-center h-96 text-gray-500",children:P?"Generating chart...":'Click "Generate Chart" to create visualization'}):e.jsx("div",{className:"h-96",children:e.jsx(te,{width:"100%",height:"100%",children:e.jsxs(re,{data:s,children:[e.jsx(le,{strokeDasharray:"3 3"}),e.jsx(ne,{dataKey:"time"}),e.jsx(H,{yAxisId:"left"}),u.showSecondaryAxis&&e.jsx(H,{yAxisId:"right",orientation:"right"}),e.jsx(ie,{}),e.jsx(de,{}),u.showThreshold&&e.jsx(oe,{y:u.thresholdValue,stroke:"red",strokeDasharray:"5 5",yAxisId:"left"}),g.map((r,d)=>e.jsx(Q,{yAxisId:"left",type:"monotone",dataKey:r,stroke:r.includes("period1")?`hsl(${d*60}, 70%, 40%)`:`hsl(${d*60}, 70%, 60%)`,strokeWidth:2,strokeDasharray:r.includes("period1")?"0":"5 5"},r)),u.showSecondaryAxis&&m.map((r,d)=>e.jsx(Q,{yAxisId:"right",type:"monotone",dataKey:r,stroke:`hsl(${(d+g.length)*60}, 70%, 50%)`,strokeWidth:2,strokeDasharray:"10 5"},r))]})})})});ee.displayName="ChartDisplay";const V=[{value:"availability",label:"Availability (%)",threshold:99},{value:"rrc",label:"RRC Success Rate (%)",threshold:98.5},{value:"erab",label:"ERAB Success Rate (%)",threshold:99},{value:"sar",label:"SAR",threshold:2.5},{value:"mobility_intra",label:"Mobility Intra (%)",threshold:95},{value:"cqi",label:"CQI",threshold:8}],ce=i.memo(()=>{var _,F;const[s,u]=i.useState({primaryKPI:"availability",secondaryKPI:"rrc",startDate1:new Date(Date.now()-12096e5).toISOString().split("T")[0],endDate1:new Date(Date.now()-6048e5).toISOString().split("T")[0],startDate2:new Date(Date.now()-6048e5).toISOString().split("T")[0],endDate2:new Date().toISOString().split("T")[0],ne:"",cellid:"",showSecondaryAxis:!0,showComparison:!0,showThreshold:!0,thresholdValue:99}),[P,N]=i.useState([]),[A,y]=i.useState(!1),[b,g]=i.useState(!1),[m,r]=i.useState(V),[d,S]=i.useState([]),[a,K]=i.useState(!1),f=i.useMemo(()=>a&&d.length>0?d:m,[a,d,m]),x=i.useCallback(async()=>{var l;try{g(!0),console.info("[AdvancedChart] Fetching DB PEGs");let n={};try{const t=localStorage.getItem("dbConfig");t&&(n=JSON.parse(t))}catch(t){console.error("Error parsing dbConfig from localStorage",t)}if(!n.host){console.warn("[AdvancedChart] No DB config found");return}const h=await L.post("/api/master/pegs",{db:n,table:n.table||"summary",limit:100}),o=((l=h==null?void 0:h.data)==null?void 0:l.pegs)||[];console.info("[AdvancedChart] DB PEGs loaded:",o.length);const j=o.map(t=>({value:t.id||t.name,label:`${t.name||t.id} (DB)`,threshold:0,isDbPeg:!0}));S(j)}catch(n){console.error("[AdvancedChart] Error fetching DB PEGs:",n)}finally{g(!1)}},[]),O=i.useCallback((l,n)=>{var k,E;if(!l||l.length===0)return[];const h=((E=(k=l[0])==null?void 0:k.data)==null?void 0:E.data)||[],o=n.showComparison&&l[1]?l[1].data.data:[],j=n.showSecondaryAxis&&l[2]?l[2].data.data:[],t={};function D(I,T){const p={};I.forEach(v=>{const w=new Date(v.timestamp).toLocaleString();p[w]||(p[w]={sum:0,cnt:0}),p[w].sum+=Number(v.value)||0,p[w].cnt+=1}),Object.keys(p).forEach(v=>{t[v]||(t[v]={time:v});const w=p[v].cnt>0?+(p[v].sum/p[v].cnt).toFixed(2):0;t[v][T]=w})}return D(h,`${n.primaryKPI}_period1`),n.showComparison&&D(o,`${n.primaryKPI}_period2`),n.showSecondaryAxis&&D(j,`${n.secondaryKPI}_secondary`),Object.values(t).sort((I,T)=>new Date(I.time)-new Date(T.time)).slice(0,200)},[]),B=i.useCallback(async()=>{try{y(!0),console.info("[AdvancedChart] Generate with config:",s,"useDbPegs:",a);const l=[];l.push(L.post("/api/kpi/query",{start_date:s.startDate1,end_date:s.endDate1,kpi_type:s.primaryKPI,ne:s.ne,cellid:s.cellid,ids:2})),s.showComparison&&l.push(L.post("/api/kpi/query",{start_date:s.startDate2,end_date:s.endDate2,kpi_type:s.primaryKPI,ne:s.ne,cellid:s.cellid,ids:2})),s.showSecondaryAxis&&s.secondaryKPI!==s.primaryKPI&&l.push(L.post("/api/kpi/query",{start_date:s.startDate2,end_date:s.endDate2,kpi_type:s.secondaryKPI,ne:s.ne,cellid:s.cellid,ids:2}));const n=await Promise.all(l);console.info("[AdvancedChart] API responses:",n.map(o=>{var j,t;return((t=(j=o==null?void 0:o.data)==null?void 0:j.data)==null?void 0:t.length)??0}));const h=O(n,s);N(h)}catch(l){console.error("[AdvancedChart] Error generating advanced chart:",l)}finally{y(!1)}},[s,a,O]);return i.useEffect(()=>{var l;try{const n=localStorage.getItem("activePreference");if(n){const h=JSON.parse(n),o=Array.isArray((l=h==null?void 0:h.config)==null?void 0:l.availableKPIs)&&h.config.availableKPIs.length>0?h.config.availableKPIs.map(t=>({value:String((t==null?void 0:t.value)||""),label:String((t==null?void 0:t.label)||(t==null?void 0:t.value)||""),threshold:Number((t==null?void 0:t.threshold)??0)})):V;r(o);const j=o.map(t=>t.value);u(t=>{var D,k,E,I;return{...t,primaryKPI:j.includes(t.primaryKPI)?t.primaryKPI:((D=o[0])==null?void 0:D.value)||"availability",secondaryKPI:j.includes(t.secondaryKPI)?t.secondaryKPI:((k=o[1])==null?void 0:k.value)||((E=o[0])==null?void 0:E.value)||"rrc",thresholdValue:((I=o.find(T=>{var p;return T.value===(j.includes(t.primaryKPI)?t.primaryKPI:((p=o[0])==null?void 0:p.value)||"availability")}))==null?void 0:I.threshold)??t.thresholdValue}})}}catch{r(V)}},[]),i.useEffect(()=>{a&&d.length===0&&x()},[a,d.length,x]),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(J,{children:[e.jsx(U,{children:e.jsxs(Y,{className:"flex items-center gap-2",children:[e.jsx(se,{className:"h-5 w-5"}),"Advanced Chart Configuration"]})}),e.jsx(X,{children:e.jsx(Z,{chartConfig:s,onConfigChange:u,kpiOptions:m,loading:A,onGenerate:B,useDbPegs:a,pegOptionsLoading:b,dbPegOptions:d})})]}),e.jsxs(J,{children:[e.jsx(U,{children:e.jsxs(Y,{children:[((_=f.find(l=>l.value===s.primaryKPI))==null?void 0:_.label)||"KPI"," Analysis",s.showSecondaryAxis&&` vs ${(F=f.find(l=>l.value===s.secondaryKPI))==null?void 0:F.label}`]})}),e.jsx(X,{children:e.jsx(ee,{chartData:P,chartConfig:s,loading:A,kpiOptions:m,useDbPegs:a,dbPegOptions:d})})]})]})});ce.displayName="AdvancedChart";export{ce as default};
