import{r as d,M as s,a3 as r}from"./vendor-D_Wz334c.js";import{g as I,C as m,b as x,c as u,d as h,e as w,B as y,L as N,I as b,t as P,v as F,w as B}from"./index-BAtDSpDQ.js";import{B as k,D as R,S as z,L as E,q as $,g as q,F as Q}from"./icon-vendor-DhUEaqm7.js";import"./utils-vendor-DrCDvq1f.js";import"./ui-vendor-D1gbbhYx.js";const V=()=>{var M;const{settings:j}=I(),n=(j==null?void 0:j.databaseSettings)||{host:"",port:5432,user:"postgres",password:"",dbname:"postgres",table:"summary"},[l,Y]=d.useState({n_minus_1:"",n:"",table:"summary",ne:"",cellid:"",preference:"",columns:{time:"datetime",peg_name:"peg_name",value:"value",ne:"ne",cellid:"cellid"}}),[L,D]=d.useState(!1),[i,p]=d.useState(null),[g,o]=d.useState(!1),[a,_]=d.useState(null),[C,H]=d.useState([]),A=async()=>{if(!n.host||!n.password){r.error("Host와 Password는 필수 입력값입니다.");return}D(!0);try{const e=await P(n);e.success?(p({type:"success",message:"Database 연결 성공"}),r.success("Database 연결이 성공했습니다.")):(p({type:"error",message:e.error}),r.error(`Database 연결 실패: ${e.error}`))}catch(e){console.error("Connection test error:",e),p({type:"error",message:e.message}),r.error("연결 테스트 중 오류가 발생했습니다.")}finally{D(!1)}},S=async()=>{if(!l.n_minus_1||!l.n){r.error("분석 기간(N-1, N)을 모두 입력해주세요.");return}if((i==null?void 0:i.type)!=="success"){r.error("먼저 Database 연결을 확인해주세요.");return}o(!0);try{console.log("🚀 LLM 분석 시작:",{dbConfig:n,analysisParams:l});const e=await F(n,l,"default");console.log("✅ LLM 분석 트리거 성공:",e),_({id:e.analysis_id,status:"processing",message:e.message,startTime:new Date}),r.success("LLM 분석이 시작되었습니다. 잠시 후 결과를 확인할 수 있습니다."),T(e.analysis_id)}catch(e){console.error("❌ LLM 분석 요청 실패:",e),r.error(`분석 요청 실패: ${e.message}`),o(!1)}},T=e=>{const c=setInterval(async()=>{try{const t=await B(e);console.log("📊 폴링 결과:",t),(t.status==="completed"||t.status==="error")&&(clearInterval(c),o(!1),_(v=>({...v,status:t.status,result:t,endTime:new Date})),H(v=>[{id:e,status:t.status,startTime:new Date,params:l,result:t},...v]),t.status==="completed"?r.success("LLM 분석이 완료되었습니다!"):r.error("LLM 분석 중 오류가 발생했습니다."))}catch(t){console.error("폴링 오류:",t),clearInterval(c),o(!1)}},5e3);setTimeout(()=>{clearInterval(c),g&&(o(!1),r.error("분석 시간이 초과되었습니다. 관리자에게 문의하세요."))},6e5)},f=(e,c)=>{Y(t=>({...t,[e]:c}))};return s.jsxs("div",{className:"space-y-6",children:[s.jsxs(m,{children:[s.jsx(x,{children:s.jsxs(u,{className:"flex items-center gap-2",children:[s.jsx(k,{className:"h-5 w-5"}),"LLM 분석 관리자"]})}),s.jsx(h,{children:s.jsx("p",{className:"text-muted-foreground",children:"PostgreSQL Database에서 데이터를 조회하여 LLM 기반 성능 분석을 수행합니다."})})]}),s.jsxs(m,{children:[s.jsx(x,{children:s.jsxs(u,{className:"flex items-center gap-2",children:[s.jsx(R,{className:"h-5 w-5"}),"Database 설정"]})}),s.jsxs(h,{children:[s.jsxs("p",{className:"text-sm text-muted-foreground",children:["Database 설정은 이제 ",s.jsx("strong",{children:"환경설정 > Database"})," 탭에서 통합 관리됩니다. 이 화면에서는 Preference에 저장된 설정을 사용합니다."]}),s.jsxs("div",{className:"mt-3 text-sm",children:[s.jsxs("div",{children:["Host: ",s.jsx("span",{className:"font-mono",children:n.host||"-"})]}),s.jsxs("div",{children:["Port: ",s.jsx("span",{className:"font-mono",children:n.port||"-"})]}),s.jsxs("div",{children:["User: ",s.jsx("span",{className:"font-mono",children:n.user||"-"})]}),s.jsxs("div",{children:["DB: ",s.jsx("span",{className:"font-mono",children:n.dbname||"-"})]}),s.jsxs("div",{children:["Table: ",s.jsx("span",{className:"font-mono",children:n.table||"-"})]})]}),s.jsxs("div",{className:"mt-4",children:[s.jsx(w,{onClick:A,disabled:L,children:L?"Testing...":"Test Connection (Preference 설정 사용)"}),i&&s.jsx(y,{className:"ml-2",variant:i.type==="success"?"default":"destructive",children:i.message})]})]})]}),s.jsxs(m,{children:[s.jsx(x,{children:s.jsxs(u,{className:"flex items-center gap-2",children:[s.jsx(z,{className:"h-5 w-5"}),"분석 파라미터"]})}),s.jsxs(h,{className:"space-y-4",children:[s.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[s.jsxs("div",{children:[s.jsx(N,{htmlFor:"n_minus_1",children:"N-1 기간"}),s.jsx(b,{id:"n_minus_1",value:l.n_minus_1,onChange:e=>f("n_minus_1",e.target.value),placeholder:"YYYY-MM-DD_HH:mm~YYYY-MM-DD_HH:mm"})]}),s.jsxs("div",{children:[s.jsx(N,{htmlFor:"n",children:"N 기간"}),s.jsx(b,{id:"n",value:l.n,onChange:e=>f("n",e.target.value),placeholder:"YYYY-MM-DD_HH:mm~YYYY-MM-DD_HH:mm"})]}),s.jsxs("div",{children:[s.jsx(N,{htmlFor:"table",children:"테이블명"}),s.jsx(b,{id:"table",value:l.table,onChange:e=>f("table",e.target.value),placeholder:"summary"})]})]}),s.jsx("div",{className:"flex items-center gap-3",children:s.jsx(w,{onClick:S,disabled:g,children:g?s.jsxs(s.Fragment,{children:[s.jsx(E,{className:"h-4 w-4 animate-spin mr-2"})," 분석 중..."]}):s.jsxs(s.Fragment,{children:[s.jsx($,{className:"h-4 w-4 mr-2"})," 분석 시작"]})})})]})]}),a&&s.jsxs(m,{children:[s.jsx(x,{children:s.jsxs(u,{className:"flex items-center gap-2",children:[s.jsx(q,{className:"h-5 w-5"}),"현재 분석 상태"]})}),s.jsxs(h,{children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsxs("p",{className:"font-medium",children:["분석 ID: ",a.id]}),s.jsx("p",{className:"text-sm text-muted-foreground",children:a.message})]}),s.jsx(y,{variant:a.status==="processing"?"default":a.status==="completed"?"success":"destructive",children:a.status==="processing"?"처리 중":a.status==="completed"?"완료":"오류"})]}),a.result&&a.status==="completed"&&s.jsxs("div",{className:"mt-4 p-4 bg-muted rounded-lg",children:[s.jsx("p",{className:"font-medium mb-2",children:"분석 결과"}),s.jsxs("div",{className:"space-y-2 text-sm",children:[a.result.report_path&&s.jsxs("p",{children:["📄 리포트: ",a.result.report_path]}),((M=a.result.results)==null?void 0:M.analysis)&&s.jsx("p",{children:"🧠 LLM 분석: 완료"})]})]})]})]}),C.length>0&&s.jsxs(m,{children:[s.jsx(x,{children:s.jsxs(u,{className:"flex items-center gap-2",children:[s.jsx(Q,{className:"h-5 w-5"}),"분석 히스토리"]})}),s.jsx(h,{children:s.jsx("div",{className:"space-y-3",children:C.map((e,c)=>s.jsxs("div",{className:"border rounded-lg p-3",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsxs("p",{className:"font-medium text-sm",children:["분석 #",c+1]}),s.jsx(y,{variant:e.status==="completed"?"success":"destructive",children:e.status==="completed"?"완료":"오류"})]}),s.jsxs("div",{className:"text-xs text-muted-foreground space-y-1",children:[s.jsxs("p",{children:["기간: ",e.params.n_minus_1," vs ",e.params.n]}),s.jsxs("p",{children:["시간: ",e.startTime.toLocaleString()]}),s.jsxs("p",{children:["ID: ",e.id]})]})]},e.id))})})]})]})};export{V as default};
